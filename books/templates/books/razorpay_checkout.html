<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<button id="rzp-button">Pay</button>
<script>
const options = {
  "key": "{{ razorpay_key_id }}",
  "amount": "{{ amount }}", // in paise
  "currency": "{{ currency }}",
  "name": "My Book Store",
  "description": "{{ book.title }}",
  "order_id": "{{ razorpay_order_id }}",
  "handler": function (response){
      // Send response to server to verify & capture
      fetch("{% url 'books:razorpay_verify' %}", {
          method: "POST",
          headers: {"Content-Type": "application/json", "X-CSRFToken": "{{ csrf_token }}"},
          body: JSON.stringify({
              razorpay_payment_id: response.razorpay_payment_id,
              razorpay_order_id: response.razorpay_order_id,
              razorpay_signature: response.razorpay_signature,
              order_id: "{{ order.order_id }}"
          })
      }).then(r=>r.json()).then(data => {
          if (data.success) {
              window.location.href = data.redirect_url || "/orders/success/";
          } else {
              alert('Payment verification failed');
          }
      });
  },
  "prefill": {"email": "{{ request.user.email if request.user.is_authenticated else '' }}"}
};
const rzp = new Razorpay(options);
document.getElementById('rzp-button').onclick = function(e){ rzp.open(); e.preventDefault(); }
</script>
